{"ts":1372319133706,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"var reader = require('./reader')\r\n   ,moment = require('moment')\r\n   ,async  = require('async');\r\n\r\nfunction Events(){}\r\n\r\nEvents.loadFeeds = function(callback){\r\n    console.log('Call Events.loadFeeds');\r\n    reader.load(function(feeds){\r\n        callback(feeds);\r\n    });\r\n};\r\n\r\nEvents.loadTags = function(callback){\r\n    console.log('/modules/events.js:Call Events.loadTags');\r\n    reader.loadTags(function(tags){\r\n        if(callback !== undefined) callback(tags);\r\n    });\r\n};\r\n\r\nEvents.loadFeedTags = function(feedId, callback){\r\n    console.log('/modules/events.js:Call Events.loadFeedTags');\r\n    reader.loadFeedTags(feedId, callback);\r\n};\r\n\r\nEvents.loadFeedArticles = function(feedId, callback){\r\n    reader.getFeedArticles(feedId, 30, function(err, articles){\r\n       callback(articles);\r\n    });\r\n};\r\n\r\nEvents.fetchArticles = function(feedId, callback){\r\n    var arr = new Array();\r\n    reader.getNewArticles(feedId, function(err, meta, articles, feed){\r\n        reader.getFeedArticles(feedId, articles.length, function(err, old){\r\n            articles.forEach(function(article){\r\n                var isSame = false;\r\n                for(var i=0; i<old.length; i++){\r\n                    var o = old[i];\r\n                    if(moment(article.date).diff(moment(o.date)) === 0){\r\n                        isSame = true;\r\n                        break;\r\n                    }\r\n                }\r\n                if(!isSame){\r\n                    arr.push(article);\r\n                }\r\n            });\r\n            \r\n            reader.addArticles(feed, arr, function(){\r\n                reader.getFeedArticles(feedId, 30, function(err, articles){\r\n                    callback(articles);\r\n                });\r\n            });\r\n        });\r\n    });\r\n};\r\n\r\nEvents.fetchTaggedArticles = function(tagId, callback){\r\n    console.log('/modules/events.js:Call Events.fetchTaggedArticles');\r\n    reader.getTaggedFeeds(tagId, function(feeds){\r\n        async.each(feeds,\r\n                    function(feed){\r\n                        console.log(feed);\r\n                        Events.fetchArticles(feed._id.toString());\r\n                    },\r\n                    function(err){\r\n                        Events.loadTaggedArticles(tagId, callback);\r\n                    });\r\n    });\r\n};\r\n\r\nEvents.addTag = function(tagname, callback){\r\n    reader.addTag(tagname, function(tag){\r\n        if(callback !== undefined)\r\n            callback(tag);\r\n    });\r\n};\r\n\r\nEvents.addFeed = function(url, callback){\r\n    reader.addFeed(url, function(feed, articles){\r\n        reader.addArticles(feed, articles);\r\n        callback(feed);\r\n    });\r\n};\r\n\r\nEvents.updateFeedTags = function(feedId, feedTags, callback){\r\n    console.log('/modules/events.js:Call Events.updateFeedTags');\r\n    reader.updateFeedTags(feedId, feedTags, callback);\r\n};\r\n\r\nEvents.loadTaggedArticles = function(tagId, callback){\r\n    console.log('/modules/events.js:Call Events.loadTaggedArticles');\r\n    reader.getTaggedFeeds(tagId, function(feeds){\r\n        var feedIds = new Array();\r\n        for(var i=0; i<feeds.length; i++){\r\n            feedIds.push(feeds[i]._id);\r\n        }\r\n        reader.getFeedsArticles(feedIds, 30, callback);\r\n    });\r\n};\r\n\r\nexports = module.exports = Events;"]],"start1":0,"start2":0,"length1":0,"length2":3243}]],"length":3243}
